<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/animate-css/animate.min.css"><script class="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"www.wuleshen.com",root:"/",scheme:"Gemini",version:"8.0.0-rc.4",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12},copycode:!0,bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"fadeInDown",post_body:"fadeInDown",coll_header:"fadeInLeft",sidebar:"fadeInUp"}},path:"search.xml"}</script><meta name="description" content="支付宝回调异步通知的相关内容以及故障排查"><meta property="og:type" content="article"><meta property="og:title" content="Java对接支付宝支付功能（三）异步通知"><meta property="og:url" content="http://www.wuleshen.com/2020/02/03/java-alipay-3/index.html"><meta property="og:site_name" content="吴乐申的博客"><meta property="og:description" content="支付宝回调异步通知的相关内容以及故障排查"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-02-03T02:10:07.000Z"><meta property="article:modified_time" content="2020-07-17T11:42:47.417Z"><meta property="article:author" content="Shawn Wu"><meta property="article:tag" content="Java"><meta property="article:tag" content="支付宝"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://www.wuleshen.com/2020/02/03/java-alipay-3/"><script class="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Java对接支付宝支付功能（三）异步通知 | 吴乐申的博客</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-134538690-1"></script><script>function gtag(){dataLayer.push(arguments)}CONFIG.hostname===location.hostname&&(window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-134538690-1"))</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d49718746cc9701151390a84a8eed002";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>body{margin-top:2rem}.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header,.use-motion .sidebar{visibility:visible}.use-motion .footer,.use-motion .header,.use-motion .site-brand-container .toggle{opacity:initial}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line{transform:scaleX(1)}.search-pop-overlay,.sidebar-nav{display:none}.sidebar-panel{display:block}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">吴乐申的博客</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Done is better than perfect</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><section class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#支付宝回调异步通知"><span class="nav-number">1.</span> <span class="nav-text">支付宝回调异步通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器异步通知页面特性"><span class="nav-number">2.</span> <span class="nav-text">服务器异步通知页面特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步返回结果的验签"><span class="nav-number">3.</span> <span class="nav-text">异步返回结果的验签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回调出错的排查"><span class="nav-number">4.</span> <span class="nav-text">回调出错的排查</span></a></li></ol></div></section><section class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Shawn Wu</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">23</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/LefterWu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;LefterWu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:wuleshen@163.com" title="E-Mail → mailto:wuleshen@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div></section></div></aside><div id="sidebar-dimmer"></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div id="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://www.wuleshen.com/2020/02/03/java-alipay-3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Shawn Wu"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="吴乐申的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Java对接支付宝支付功能（三）异步通知</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-02-03 10:10:07" itemprop="dateCreated datePublished" datetime="2020-02-03T10:10:07+08:00">2020-02-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-07-17 19:42:47" itemprop="dateModified" datetime="2020-07-17T19:42:47+08:00">2020-07-17</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E9%A1%B9%E7%9B%AE/%E6%94%AF%E4%BB%98/" itemprop="url" rel="index"><span itemprop="name">支付</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/2020/02/03/java-alipay-3/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2020/02/03/java-alipay-3/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>6.9k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>6 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>支付宝回调异步通知的相关内容以及故障排查</p><a id="more"></a><h3 id="支付宝回调异步通知"><a href="#支付宝回调异步通知" class="headerlink" title="支付宝回调异步通知"></a>支付宝回调异步通知</h3><p><a href="https://docs.open.alipay.com/194/103296/" target="_blank" rel="noopener">当面付异步通知</a></p><p>当商户调用预下单请求API生成二维码展示给用户后，用户通过手机扫描二维码进行支付，支付宝会将该笔订单的变更信息，沿着商户调用预下单请求时所传入的通知地址主动推送给商户。</p><p>通知触发条件：交易状态为<code>TRADE_SUCCESS</code></p><h3 id="服务器异步通知页面特性"><a href="#服务器异步通知页面特性" class="headerlink" title="服务器异步通知页面特性"></a>服务器异步通知页面特性</h3><ol><li>必须保证服务器异步通知页面（notify_url）上无任何字符，如空格、HTML标签、开发系统自带抛出的异常提示信息等；</li><li>支付宝是用POST方式发送通知信息，因此该页面中获取参数的方式，如：request.Form(“out_trade_no”)、$_POST[‘out_trade_no’]；</li><li>支付宝主动发起通知，该方式才会被启用；</li><li>只有在支付宝的交易管理中存在该笔交易，且发生了交易状态的改变，支付宝才会通过该方式发起服务器通知（即时到账中交易状态为“等待买家付款”的状态默认是不会发送通知的）；</li><li>服务器间的交互，不像页面跳转同步通知可以在页面上显示出来，这种交互方式是不可见的；</li><li>第一次交易状态改变（即时到账中此时交易状态是交易完成）时，不仅会返回同步处理结果，而且服务器异步通知页面也会收到支付宝发来的处理结果通知；</li><li><strong>程序执行完后必须打印输出“success”（不包含引号）。</strong>如果商户反馈给支付宝的字符不是success这7个字符，支付宝服务器会不断重发通知，直到超过24小时22分钟。一般情况下，25小时以内完成8次通知（通知的间隔频率一般是：4m,10m,10m,1h,2h,6h,15h）；</li><li>程序执行完成后，该页面不能执行页面跳转。（不能有重定向）如果执行页面跳转，支付宝会收不到success字符，会被支付宝服务器判定为该页面程序运行出现异常，而重发处理结果通知；</li><li>cookies、session等在此页面会失效，即无法获取这些数据；</li><li>该方式的调试与运行必须在服务器上，即互联网上能访问；（如果本地调试，需要使用内网穿透）</li><li>该方式的作用主要防止订单丢失，即页面跳转同步通知没有处理订单更新，它则去处理；</li><li><strong>当商户收到服务器异步通知并打印出success时，服务器异步通知参数notify_id才会失效。</strong>也就是说在支付宝发送同一条异步通知时（包含商户并未成功打印出success导致支付宝重发数次通知），服务器异步通知参数notify_id是不变的。</li></ol><h3 id="异步返回结果的验签"><a href="#异步返回结果的验签" class="headerlink" title="异步返回结果的验签"></a>异步返回结果的验签</h3><p>实例：某商户设置的通知地址为<a href="https://api.xx.com/receive_notify.htm%EF%BC%8C%E5%AF%B9%E5%BA%94%E6%8E%A5%E6%94%B6%E5%88%B0%E9%80%9A%E7%9F%A5%E7%9A%84%E7%A4%BA%E4%BE%8B%E5%A6%82%E4%B8%8B%EF%BC%9A" target="_blank" rel="noopener">https://api.xx.com/receive_notify.htm，对应接收到通知的示例如下：</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;api.xx.com&#x2F;receive_notify.htm?</span><br><span class="line">gmt_payment&#x3D;2015-06-11 22:33:59</span><br><span class="line">&amp;notify_id&#x3D;42af7baacd1d3746cf7b56752b91edcj34</span><br><span class="line">&amp;seller_email&#x3D;testyufabu07@alipay.com</span><br><span class="line">&amp;notify_type&#x3D;trade_status_sync</span><br><span class="line">&amp;sign&#x3D;kPbQIjX+xQc8F0&#x2F;A6&#x2F;AocELIjhhZnGbcBN6G4MM&#x2F;HmfWL4ZiHM6fWl5NQhzXJusaklZ1LFuMo+lHQUELAYeugH8LYFvxnNajOvZhuxNFbN2LhF0l&#x2F;KL8ANtj8oyPM4NN7Qft2kWJTDJUpQOzCzNnV9hDxh5AaT9FPqRS6ZKxnzM&#x3D;&amp;trade_no&#x3D;2015061121001004400068549373</span><br><span class="line">&amp;out_trade_no&#x3D;21repl2ac2eOutTradeNo322</span><br><span class="line">&amp;gmt_create&#x3D;2015-06-11 22:33:46</span><br><span class="line">&amp;seller_id&#x3D;2088211521646673</span><br><span class="line">&amp;notify_time&#x3D;2015-06-11 22:34:03</span><br><span class="line">&amp;subject&#x3D;FACE_TO_FACE_PAYMENT_PRECREATE中文</span><br><span class="line">&amp;trade_status&#x3D;TRADE_SUCCESS</span><br><span class="line">&amp;sign_type&#x3D;RSA2</span><br></pre></td></tr></table></figure><p><strong>第一步：</strong> 在通知返回参数列表中，除去sign、sign_type两个参数外，凡是通知返回回来的参数皆是待验签的参数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">logger.debug(<span class="string">"**********************支付宝回调开始**********************"</span>);		</span><br><span class="line"><span class="comment">// 得到并遍历回调传来的参数</span></span><br><span class="line">Map&lt;String, String[]&gt; requestParams = request.getParameterMap();</span><br><span class="line">Map&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="comment">// 将前台的参数转换为"xxx"-&gt;"aaa,bbb"的格式存入params中,实际上回调传来的参数每个key都只对应一个value</span></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, String[]&gt; entry: requestParams.entrySet()) &#123;</span><br><span class="line">    String key = entry.getKey();</span><br><span class="line">    String values[] = entry.getValue();</span><br><span class="line">    StringBuilder valStr = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i ++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( i != values.length - <span class="number">1</span>) &#123;</span><br><span class="line">            valStr.append(values[i]).append(<span class="string">","</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            valStr.append(values[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    params.put(key, valStr.toString());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 日志打印回调信息，包括签名，支付状态，所有参数</span></span><br><span class="line">logger.info(<span class="string">"alipay_callback, sign:&#123;&#125;, trade_status:&#123;&#125;, params:&#123;&#125;"</span>, params.get(<span class="string">"sign"</span>), params.get(<span class="string">"trade_status"</span>),params.toString());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要除去sign、sign_type两个参数，而sign已经在#rsaCheckV2方法中除去了</span></span><br><span class="line">params.remove(<span class="string">"sign_type"</span>);</span><br></pre></td></tr></table></figure><p><strong>第二步：</strong> 将剩下参数进行url_decode, 然后进行字典排序，组成字符串，得到待签名字符串</p><p><strong>第三步：</strong> 将签名参数（sign）使用base64解码为字节码串。</p><p>​ 第二步和第三步在支付宝提供的<code>rsaCheckV2</code>方法中已经实现</p><p><strong>第四步：</strong> 使用RSA的验签方法，通过签名字符串、签名参数（经过base64解码）及支付宝公钥验证签名。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 使用RSA的验签方法，通过签名字符串、签名参数（经过base64解码）及支付宝公钥验证签名</span></span><br><span class="line">    <span class="keyword">boolean</span> rsaCheckV2 = AlipaySignature.rsaCheckV2(params, Configs.getAlipayPublicKey(), <span class="string">"utf-8"</span>, Configs.getSignType());</span><br><span class="line">	<span class="comment">// 验签失败</span></span><br><span class="line">	<span class="keyword">if</span> ( !rsaCheckV2 ) &#123;</span><br><span class="line">	<span class="keyword">return</span> ServerResponse.createByErrorMessage(<span class="string">"验签失败，检测到非法请求"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (AlipayApiException e) &#123;</span><br><span class="line">	logger.error(<span class="string">"支付宝回调异常"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是rsaCheckV2有两个重载的方法，一个是带signType参数的，我们需要使用这个方法指定签名类型为RSA2（可以从之前装配的Configs类直接获取），而不带signType的方法默认使用SHA1WithRSA的类型</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 支付宝提供的验签方法，内部已经实现了除去sign参数、字典排序成待签名字符串、将sign使用base64解码为字节码串</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">rsaCheckV2</span><span class="params">(Map&lt;String, String&gt; params, String publicKey,</span></span></span><br><span class="line"><span class="function"><span class="params">            String charset,String signType)</span> <span class="keyword">throws</span> AlipayApiException </span>&#123;</span><br><span class="line">    String sign = params.get(<span class="string">"sign"</span>);</span><br><span class="line">    String content = getSignCheckContentV2(params);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> rsaCheck(content, sign, publicKey, charset,signType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getSignCheckContentV2</span><span class="params">(Map&lt;String, String&gt; params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (params == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    params.remove(<span class="string">"sign"</span>);</span><br><span class="line"></span><br><span class="line">    StringBuffer content = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    List&lt;String&gt; keys = <span class="keyword">new</span> ArrayList&lt;String&gt;(params.keySet());</span><br><span class="line">    Collections.sort(keys);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; keys.size(); i++) &#123;</span><br><span class="line">    String key = keys.get(i);</span><br><span class="line">    String value = params.get(key);</span><br><span class="line">    content.append((i == <span class="number">0</span> ? <span class="string">""</span> : <span class="string">"&amp;"</span>) + key + <span class="string">"="</span> + value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> content.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">rsaCheck</span><span class="params">(String content, String sign, String publicKey, String charset,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   String signType)</span> <span class="keyword">throws</span> AlipayApiException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (AlipayConstants.SIGN_TYPE_RSA.equals(signType)) &#123;</span><br><span class="line">        <span class="keyword">return</span> rsaCheckContent(content, sign, publicKey, charset);</span><br><span class="line">        <span class="comment">// 这里使用的是RSA2的签名方法</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AlipayConstants.SIGN_TYPE_RSA2.equals(signType)) &#123;</span><br><span class="line">        <span class="keyword">return</span> rsa256CheckContent(content, sign, publicKey, charset);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AlipayApiException(<span class="string">"Sign Type is Not Support : signType="</span> + signType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>第五步：需要严格按照如下描述校验通知数据的正确性。</strong></p><p><strong>商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号，并判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额），同时需要校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email），上述有任何一个验证不通过，则表明本次通知是异常通知，务必忽略。在上述验证通过后商户必须根据支付宝不同类型的业务通知，正确的进行不同的业务处理，并且过滤重复的通知结果数据。在支付宝的业务通知中，只有交易通知状态为TRADE_SUCCESS或TRADE_FINISHED时，支付宝才会认定为买家付款成功。</strong></p><p><strong>注意：</strong></p><ul><li><p>状态TRADE_SUCCESS的通知触发条件是商户签约的产品支持退款功能的前提下，买家付款成功；</p></li><li><p>交易状态TRADE_FINISHED的通知触发条件是商户签约的产品不支持退款功能的前提下，买家付款成功；或者，商户签约的产品支持退款功能的前提下，交易已经成功并且已经超过可退款期限。</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 商户需要校验通知数据的正确性</span></span><br><span class="line">ServerResponse serverResponse = iOrderService.alipayCallback(params);</span><br><span class="line"><span class="comment">// 校验成功，一定要打印出“success”</span></span><br><span class="line"><span class="keyword">if</span> (serverResponse.isSuccuess()) &#123;</span><br><span class="line"><span class="keyword">return</span> Const.AlipayCallback.RESPONSE_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> Const.AlipayCallback.RESPONSE_FAILED;</span><br></pre></td></tr></table></figure><p>商户需要依次校验通知数据的正确性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ServerResponse <span class="title">alipayCallback</span><span class="params">(Map&lt;String, String&gt; params)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 支付宝外部订单号，也就是商城订单号</span></span><br><span class="line">    Long orderNo = Long.valueOf(params.get(<span class="string">"out_trade_no"</span>));</span><br><span class="line">    logger.debug(<span class="string">"out_trade_no: &#123;&#125;"</span>, orderNo.toString());</span><br><span class="line">    <span class="comment">// 支付宝交易号</span></span><br><span class="line">    String tradeNo = params.get(<span class="string">"trade_no"</span>);</span><br><span class="line">    <span class="comment">// 交易状态</span></span><br><span class="line">    String tradeStatus = params.get(<span class="string">"trade_status"</span>);</span><br><span class="line">    logger.debug(<span class="string">"trade_status: &#123;&#125;"</span>, tradeStatus);</span><br><span class="line">    Order order = orderMapper.selectByOrderNo(orderNo);</span><br><span class="line">    <span class="keyword">if</span> (order == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.createByErrorMessage(<span class="string">"不是该商城订单，忽略回调"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断交易状态</span></span><br><span class="line">    <span class="comment">// 交易状态为已付款，已发货，订单完成，订单关闭时，为重复调用</span></span><br><span class="line">    <span class="keyword">if</span> (order.getStatus() &gt;= Const.OrderStatusEnum.PAID.getCode()) &#123;</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.createBySuccess(<span class="string">"支付宝重复调用"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 交易成功，记录付款时间，更新订单状态为已付款</span></span><br><span class="line">    <span class="keyword">if</span> (Const.AlipayCallback.TRADE_STATUS_TRADE_SUCCESS.equals(tradeStatus)) &#123;</span><br><span class="line">        order.setPaymentTime(DateTimeUtil.strToDate(params.get(<span class="string">"gmt_payment"</span>)));</span><br><span class="line">        order.setStatus(Const.OrderStatusEnum.PAID.getCode());</span><br><span class="line">        orderMapper.updateByPrimaryKeySelective(order);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 组装支付信息对象，略</span></span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">return</span> ServerResponse.createBySuccess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="回调出错的排查"><a href="#回调出错的排查" class="headerlink" title="回调出错的排查"></a>回调出错的排查</h3><p>如果回调出现问题，支付宝提供了一些自查方案可以先自行排查</p><p><a href="https://openclub.alipay.com/read.php?tid=1677&fid=25&page=1" target="_blank" rel="noopener">收不到异步通知自查方案-支付宝接口常见错误系列</a></p><p><a href="https://openclub.alipay.com/read.php?tid=675&fid=60" target="_blank" rel="noopener">收不到异步通知「自检方案」</a></p><ol><li>需http://或者https://格式的完整路径<br>例：https://您的域名/notify_url.php ，支持ip地址方式。（<strong>推荐使用域名</strong>）</li><li>不能加?id=123这类自定义参数<br>错误示例：https://您的域名/notify_url.php？id=123&amp;test=abc</li><li>必须外网可以正常访问，这个不难理解，在您的异步地址没有代码逻辑的情况下，直接访问应该是一个空白 页面并且http状态是200（不支持http200以外的状态）</li><li>不能有重定向 如：http302</li><li>使用POST方式接收，请确保服务器路由已经开放POST通知</li></ol></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>Shawn Wu</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://www.wuleshen.com/2020/02/03/java-alipay-3/" title="Java对接支付宝支付功能（三）异步通知">http://www.wuleshen.com/2020/02/03/java-alipay-3/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-cn" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Java/" rel="tag"># Java</a> <a href="/tags/%E6%94%AF%E4%BB%98%E5%AE%9D/" rel="tag"># 支付宝</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/02/01/java-alipay-2/" rel="prev" title="Java对接支付宝功能（二）当面付预下单"><i class="fa fa-chevron-left"></i> Java对接支付宝功能（二）当面付预下单</a></div><div class="post-nav-item"><a href="/2020/02/09/url-to-webpage/" rel="next" title="从浏览器输入URL到页面加载展示，中间发生了什么">从浏览器输入URL到页面加载展示，中间发生了什么 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Shawn Wu</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span title="站点总字数">61k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">56 分钟</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdnjs.cloudflare.com/ajax/libs/valine/1.4.14/Valine.min.js', () => {
    new Valine(Object.assign({
      el  : '#valine-comments',
      path: location.pathname,
    }, {"enable":true,"appId":"xQrki4l2bmKSXWKVxyFMR3Na-gzGzoHsz","appKey":"4zBxvfis1YCt0Rj3ihm0g6o4","placeholder":"欢迎留言","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"language":"zh-cn","visitor":false,"comment_count":true,"recordIP":false,"serverURLs":null}
    ));
  }, window.Valine);
});</script></body></html>